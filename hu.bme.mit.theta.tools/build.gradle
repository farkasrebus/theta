import com.github.jengelman.gradle.plugins.shadow.tasks.*
import com.github.jengelman.gradle.plugins.shadow.*

plugins { id "com.github.johnrengelman.shadow" version "1.2.4" }

dependencies {
  compile project(':hu.bme.mit.theta.common')
  compile project(':hu.bme.mit.theta.core')
  compile project(':hu.bme.mit.theta.formalism.sts')
  compile project(':hu.bme.mit.theta.formalism.cfa')
  compile project(':hu.bme.mit.theta.formalism.xta')
  compile project(':hu.bme.mit.theta.analysis')
  compile group: 'com.beust', name: 'jcommander', version: jcommanderVersion
  compile group: 'com.google.guava', name: 'guava', version: guavaVersion
  testCompile group: 'junit', name: 'junit', version: junitVersion
}

def getCommitId() {
    def commit = new ByteArrayOutputStream()
    def branch = new ByteArrayOutputStream()
    exec {
        commandLine 'git', 'rev-parse', '--short', 'HEAD'
        standardOutput = commit
    }
    exec {
        commandLine 'git', 'rev-parse', '--abbrev-ref', 'HEAD'
        standardOutput = branch
    }
    def id = branch.toString() + "-" + commit.toString()

    return id.replace("\n", "").replace("/", "-").replace("\\", "-")
}

task cfaMain(type: ShadowJar) {
    group = ShadowJavaPlugin.SHADOW_GROUP
    manifest.inheritFrom project.tasks.jar.manifest
    doFirst {
            def files = project.configurations.findByName(ShadowBasePlugin.CONFIGURATION_NAME).files
            if (files) {
                def libs = [tasks.jar.manifest.attributes.get('Class-Path')]
                libs.addAll files.collect { "${it.name}" }
                manifest.attributes 'Class-Path': libs.findAll { it }.join(' ')
            }
    }
    from(sourceSets.main.output)
    configurations = [ project.configurations.runtime ]
    //exclude('META-INF/INDEX.LIST', 'META-INF/*.SF', 'META-INF/*.DSA', 'META-INF/*.RSA')
    //classifier = 'fat'
    //mergeServiceFiles()
    manifest { attributes('Main-Class': 'hu.bme.mit.theta.tools.cfa.CfaMain', 'Implementation-Version': getCommitId()) }
    baseName = 'theta-cfa'
    classifier = null
    version = null
}

task stsMain(type: ShadowJar) {
    group = ShadowJavaPlugin.SHADOW_GROUP
    manifest.inheritFrom project.tasks.jar.manifest
    doFirst {
            def files = project.configurations.findByName(ShadowBasePlugin.CONFIGURATION_NAME).files
            if (files) {
                def libs = [tasks.jar.manifest.attributes.get('Class-Path')]
                libs.addAll files.collect { "${it.name}" }
                manifest.attributes 'Class-Path': libs.findAll { it }.join(' ')
            }
    }
    from(sourceSets.main.output)
    configurations = [ project.configurations.runtime ]
    //exclude('META-INF/INDEX.LIST', 'META-INF/*.SF', 'META-INF/*.DSA', 'META-INF/*.RSA')
    //classifier = 'fat'
    //mergeServiceFiles()
    manifest { attributes('Main-Class': 'hu.bme.mit.theta.tools.sts.StsMain', 'Implementation-Version': getCommitId()) }
    baseName = 'theta-sts'
    classifier = null
    version = null
}

task xtaMain(type: ShadowJar) {
    group = ShadowJavaPlugin.SHADOW_GROUP
    manifest.inheritFrom project.tasks.jar.manifest
    doFirst {
            def files = project.configurations.findByName(ShadowBasePlugin.CONFIGURATION_NAME).files
            if (files) {
                def libs = [tasks.jar.manifest.attributes.get('Class-Path')]
                libs.addAll files.collect { "${it.name}" }
                manifest.attributes 'Class-Path': libs.findAll { it }.join(' ')
            }
    }
    from(sourceSets.main.output)
    configurations = [ project.configurations.runtime ]
    //exclude('META-INF/INDEX.LIST', 'META-INF/*.SF', 'META-INF/*.DSA', 'META-INF/*.RSA')
    //classifier = 'fat'
    //mergeServiceFiles()
    manifest { attributes('Main-Class': 'hu.bme.mit.theta.tools.xta.XtaMain', 'Implementation-Version': getCommitId()) }
    baseName = 'theta-xta'
    classifier = null
    version = null
}

task cfa2dot(type: ShadowJar) {
	group = ShadowJavaPlugin.SHADOW_GROUP
    manifest.inheritFrom project.tasks.jar.manifest
    doFirst {
            def files = project.configurations.findByName(ShadowBasePlugin.CONFIGURATION_NAME).files
            if (files) {
                def libs = [tasks.jar.manifest.attributes.get('Class-Path')]
                libs.addAll files.collect { "${it.name}" }
                manifest.attributes 'Class-Path': libs.findAll { it }.join(' ')
            }
    }
    from(sourceSets.main.output)
    configurations = [ project.configurations.runtime ]
    //exclude('META-INF/INDEX.LIST', 'META-INF/*.SF', 'META-INF/*.DSA', 'META-INF/*.RSA')
    //classifier = 'fat'
    //mergeServiceFiles()
    manifest { attributes('Main-Class': 'hu.bme.mit.theta.tools.cfa.CfaToDotMain', 'Implementation-Version': getCommitId()) }
    baseName = 'cfa2dot'
    classifier = null
    version = null
}